<!DOCTYPE html>
<html lang="en">
  <head>
    <!-- Meta information and linking to CSS, Bootstrap, Font Awesome, and JS files -->
    <meta charset="UTF-8" />
    <!-- Set character encoding to UTF-8 -->
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />
    <!-- Compatibility for Internet Explorer -->
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <!-- Responsive scaling on mobile devices -->
    <!-- Linking to external CSS and JavaScript resources -->
    <link rel="stylesheet" href="public/CSS/style.css" />
    <!-- Custom styling -->
    <link
      rel="stylesheet"
      href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.6.0/css/all.min.css"
    />
    <!-- Font Awesome icons -->
    <!-- <script src="public/JavaScript/products.js"></script> -->
    <!-- Script for product data -->
    <link
      href="https://cdn.jsdelivr.net/npm/bootstrap@5.0.2/dist/css/bootstrap.min.css"
      rel="stylesheet"
      integrity="sha384-EVSTQN3/azprG1Anm3QDgpJLIm9Nao0Yz1ztcQTwFspd3yD65VohhpuuCOmLASjC"
      crossorigin="anonymous"
    />
    <!-- Bootstrap CSS for layout and styling -->
    <!-- Bootstrap JavaScript for functionality like modals and dropdowns -->
    <script
      src="https://cdn.jsdelivr.net/npm/bootstrap@5.0.2/dist/js/bootstrap.bundle.min.js"
      integrity="sha384-MrcW6ZMFYlzcLA8Nl+NtUVF0sA7MsXsP1UyJoMp4YLEuNSfAP+JcXn/tWtIaxVXM"
      crossorigin="anonymous"
    ></script>
    <script src="https://unpkg.com/vue@2.7.8/dist/vue.js"></script>
    <!-- Vue.js framework for reactive UI -->
    <title>Tutordays</title>
  </head>
  <body>
    <div id="App">
      <!-- Vue.js application root element -->
      <header class="nav">
        <!-- Header with branding, search, and checkout button -->
        <div class="container mb-4 mt-3">
          <div class="row">
            <div class="col-6">
              <!-- Display sitename dynamically with Vue's `v-text` directive -->
              <h1 v-text="sitename"></h1>
            </div>
            <!-- Search bar and checkout button with styling -->
            <div class="col-6" style="display: flex; justify-content: flex-end">
              <i class="fa-solid fa-magnifying-glass search-icon"></i>
              <input
                type="text"
                v-model="searchQuery"
                placeholder="Search Tutordays.com"
                class="form-control"
                style="width: 200px; margin-right: 10px"
              />
              <!-- Vue binds input to searchQuery variable -->
              <!-- Checkout button with dynamic cart count and styling -->
              <button
                v-on:click="showCheckout"
                :disabled="itemsInTheCart === 0"
                class="btn btn-secondary"
                style="margin-left: 10px; background-color: green; color: white"
              >
                {{ itemsInTheCart }}
                <!-- Displays number of items in cart -->
                <span class="fa-solid fa-cart-shopping"></span>
                <!-- Cart icon -->
                Checkout
              </button>
            </div>
          </div>
        </div>
      </header>

      <main>
        <!-- Main product and checkout views with conditional rendering -->
        <!-- Products Section -->
        <div v-if="showProduct">
          <!-- Products Section: displays products when showProduct is true -->
          <div class="container mb-3">
            <h2 class="productH2">
              Explore Quality Educational Products with Tutordays
            </h2>
          </div>
          <!-- Sorting Section -->
          <!-- Sorting and ordering options for products -->
          <div class="container mb-3" class="bo">
            <h4>Sort Items by:</h4>
            <select
              v-model="sortKey"
              class="form-select"
              aria-label="Sort select"
            >
              <!-- Sorting options by product fields -->
              <option value="subject">Subject</option>
              <option value="description">Description</option>
              <option value="price">Price</option>
              <option value="location">Location</option>
              <option value="availableInventory">Available Items</option>
              <option value="rating">Rating</option>
            </select>
          </div>
          <!-- Order Section -->
          <!-- Dropdown for ordering items by ascending or descending -->
          <div class="container mb-3">
            <h4>Order Items by:</h4>
            <select
              v-model="orderKey"
              class="form-select"
              aria-label="Order select"
            >
              <!-- Vue binds selected order value to orderKey -->
              <option value="Ascending">Ascending</option>
              <option value="Descending">Descending</option>
            </select>
          </div>
          <!-- Display list of products -->
          <div class="container">
            <div class="row">
              <div
                class="col-4"
                v-for="product in filteredProducts"
                :key="product.id"
              >
                <!-- Loop through filtered products -->

                <!-- Display product details and Buy Now button -->
                <img
                  :src="`${backendApiBaseUrl}/${product.image}`"
                  alt="Product Image"
                  style="width: 100%; height: auto; object-fit: cover"
                />

                <h2>{{ product.subject }}</h2>
                <p>{{ product.description }}</p>
                <p>Price: £{{ product.price }}</p>
                <p>Location: {{ product.location }}</p>
                <p>Available Stock: {{ product.availableInventory }}</p>

                <!-- Star Rating Display -->
                <div>
                  <span v-for="n in product.rating" :key="'filled-' + n"
                    >★</span
                  >
                  <span v-for="n in 5 - product.rating" :key="'empty-' + n"
                    >☆</span
                  >
                </div>

                <div>
                  <span v-if="product.availableInventory === 0">
                    <!-- Button disabled if product is out of stock -->
                    <button
                      class="btn add-to-cart-btn"
                      style="color: red"
                      disabled
                    >
                      Out of Stock
                    </button>
                    All out!
                  </span>

                  <span
                    v-else-if="product.availableInventory > 0 && product.availableInventory < 5"
                  >
                    <!-- Notify of low stock if below 5 items remaining -->
                    Only {{ product.availableInventory }} left!
                    <button
                      v-on:click="addItemToTheCart(product)"
                      class="btn add-to-cart-btn"
                      style="color: white; background-color: green"
                    >
                      <!-- Add item to cart -->
                      Buy Now!
                    </button>
                  </span>

                  <span v-else-if="product.availableInventory >= 5">
                    <!-- Display Buy Now button for items with sufficient stock -->
                    <button
                      v-on:click="addItemToTheCart(product)"
                      class="btn add-to-cart-btn"
                      style="color: white; background-color: green"
                    >
                      Buy Now!
                    </button>
                  </span>
                </div>
              </div>
            </div>
          </div>
        </div>

        <!-- Checkout Section: displays when showProduct is false -->
        <!-- Checkout Section -->
        <div v-else>
          <div class="container mb-3">
            <h1>Welcome to the Checkout page</h1>

            <div v-if="cart.length > 0">
              <!-- Cart items list -->
              <h2>Your Cart:</h2>
              <ul>
                <li v-for="(item, index) in cart" :key="item.id + '-' + index">
                  <!-- Show product details with remove option -->
                  <img
                    v-bind:src="item.image"
                    alt="Product Image"
                    style="width: 50px; height: auto; margin-right: 10px"
                  />
                  {{ item.subject }} - Price: £{{ item.price }}
                  <button
                    v-on:click="removeItemFromCart(item, index)"
                    class="btn btn-danger btn-sm"
                    style="margin-left: 10px"
                  >
                    Remove
                  </button>
                </li>
              </ul>
            </div>

            <div v-else>
              <!-- Empty cart message -->
              <h2>Your Cart is Empty!</h2>
              <p>
                Please add items to your cart before proceeding to checkout.
              </p>
            </div>
          </div>
          <!-- Customer Information Form for Order -->
          <div class="container mb-3">
            <h2>Enter Your Information</h2>
            <form @submit.prevent="submitForm">
              <!-- Submit form with validation -->
              <!-- Input fields with validation feedback for each field -->
              <div class="mb-3">
                <label for="firstName" class="form-label">First Name:</label>
                <input
                  type="text"
                  class="form-control"
                  id="firstName"
                  v-model.trim="order.firstName"
                  v-on:input="validateName('firstName')"
                  required
                />
                <span class="error text-danger" v-if="errors.firstName"
                  >{{ errors.firstName }}</span
                >
              </div>

              <div class="mb-3">
                <label for="lastName" class="form-label">Last Name:</label>
                <input
                  type="text"
                  class="form-control"
                  id="lastName"
                  v-model.trim="order.lastName"
                  v-on:input="validateName('lastName')"
                  required
                />
                <span class="error text-danger" v-if="errors.lastName"
                  >{{ errors.lastName }}</span
                >
              </div>

              <div class="mb-3">
                <label for="phoneNumber" class="form-label"
                  >Phone Number:</label
                >
                <input
                  type="tel"
                  class="form-control"
                  id="phoneNumber"
                  v-model.trim="order.phoneNumber"
                  v-on:input="validatePhoneNumber"
                  required
                />
                <span class="error text-danger" v-if="errors.phoneNumber"
                  >{{ errors.phoneNumber }}</span
                >
              </div>

              <div class="mb-3">
                <label for="address" class="form-label">Address:</label>
                <input
                  type="text"
                  class="form-control"
                  id="address"
                  v-model.trim="order.address"
                />
              </div>

              <div class="mb-3">
                <label for="city" class="form-label">City:</label>
                <input
                  type="text"
                  class="form-control"
                  id="city"
                  v-model.trim="order.city"
                />
              </div>

              <div class="mb-3">
                <label for="state" class="form-label">State:</label>
                <select v-model="order.state" class="form-control" id="state">
                  <option disabled value="">Select State</option>
                  <option v-for="(name, code) in states" :value="code">
                    {{ name }}
                  </option>
                </select>
              </div>

              <div class="mb-3">
                <label for="zip" class="form-label">Zip/Postal Code:</label>
                <input
                  type="text"
                  class="form-control"
                  id="zip"
                  v-model.number="order.zip"
                />
              </div>

              <div class="mb-3 form-check">
                <input
                  type="checkbox"
                  class="form-check-input"
                  id="gift"
                  v-model="order.gift"
                />
                <label class="form-check-label" for="gift">Ship As Gift</label>
              </div>

              <div class="mb-3">
                <label class="form-label">Shipping Method:</label>
                <div>
                  <input
                    type="radio"
                    id="home"
                    value="Home"
                    v-model="order.method"
                    class="form-check-input"
                  />
                  <label class="form-check-label" for="home">Home</label>
                </div>
                <div>
                  <input
                    type="radio"
                    id="business"
                    value="Business"
                    v-model="order.method"
                    class="form-check-input"
                  />
                  <label class="form-check-label" for="business"
                    >Business</label
                  >
                </div>
              </div>

              <!-- "Place Order" button -->
              <button
                type="submit"
                class="btn add-to-cart-btn"
                style="color: white"
              >
                Place Order
              </button>

              <h2>Order Information</h2>
              <p v-if="order.firstName">First Name: {{ order.firstName }}</p>
              <p v-if="order.lastName">Last Name: {{ order.lastName }}</p>
              <p v-if="order.phoneNumber">
                Phone Number: {{ order.phoneNumber }}
              </p>
              <p v-if="order.address">Address: {{ order.address }}</p>
              <p v-if="order.city">City: {{ order.city }}</p>
              <p v-if="order.zip">Zip: {{ order.zip }}</p>
              <p v-if="order.state">
                State: {{ getFullStateName(order.state) }}
              </p>

              <!-- Back to Products Button -->
              <button
                type="button"
                v-on:click="showCheckout"
                class="btn btn-primary mt-3"
              >
                Back to Products
              </button>
            </form>
          </div>
        </div>
      </main>
    </div>
    <!-- Vue instance initialisation -->
    <script>
     
      let webstore = new Vue({
        el: "#App",
        data: {
          sitename: "Tutordays",
          backendApiBaseUrl: "https://tutordays.eu-west-2.elasticbeanstalk.com", 
          showProduct: true,
          products: [], // Initialize as empty array
          searchQuery: "",
          sortKey: "subject",
          orderKey: "Ascending",
          cart: [],
          order: {
            firstName: "",
            lastName: "",
            address: "",
            city: "",
            zip: "",
            state: "",
            method: "Home",
            gift: false,
          },
          states: {
            AL: "Alabama",
            AR: "Arizona",
            CA: "California",
            NV: "Nevada",
          },
          errors: {
            firstName: "",
            lastName: "",
            phoneNumber: "",
          },
        },
        methods: {
          fetchData: async function () {
            try {
              const response = await fetch(
                `${this.backendApiBaseUrl}/collections/products`
              );
              if (!response.ok) {
                throw new Error(`Error fetching data: ${response.statusText}`);
              }
              const data = await response.json();
              this.products = data;
              console.log("Fetched products:", data);
            } catch (error) {
              console.error("Fetch error:", error);
              alert("Failed to fetch products. Please try again later.");
            }
          },
          showCheckout: function () {
            this.showProduct = !this.showProduct;
          },
          addItemToTheCart: function (product) {
            this.cart.push({
              id: product.id,
              subject: product.subject,
              price: product.price,
              location: product.location,
              quantity: 1,
              image: product.image,
            });
            product.availableInventory--;
          },
          canAddToTheCart: function (product) {
            return product.availableInventory > 0;
          },
          removeItemFromCart: function (item, index) {
            const product = this.products.find((p) => p.id === item.id);
            if (product) {
              product.availableInventory++;
            }
            this.cart.splice(index, 1);
          },
          validateName: function (field) {
            const nameRegex = /^[A-Za-z\s]+$/;
            if (!nameRegex.test(this.order[field])) {
              this.errors[field] = "Only letters and spaces are allowed!";
            } else {
              this.errors[field] = "";
            }
          },
          validatePhoneNumber: function () {
            const phoneRegex = /^[0-9]+$/;
            if (!phoneRegex.test(this.order.phoneNumber)) {
              this.errors.phoneNumber =
                "Only numbers are allowed in the phone number!";
            } else {
              this.errors.phoneNumber = "";
            }
          },
          submitForm: function () {
            if (this.cart.length === 0) {
              alert(
                "Your cart is empty! Please add items to your cart before submitting an order."
              );
              return;
            }
            this.validateName("firstName");
            this.validateName("lastName");
            this.validatePhoneNumber();
            if (
              !this.errors.firstName &&
              !this.errors.lastName &&
              !this.errors.phoneNumber
            ) {
              alert(
                "Congratulations! Your Order Has Been Successfully Submitted!  Your Order Is Being Processed! Feel Free To Browse And Explore More Great Finds While We Take Care Of The Rest. Have An Amazing Day!"
              );
              this.order = {
                firstName: "",
                lastName: "",
                address: "",
                city: "",
                zip: "",
                state: "",
                method: "Home",
                gift: false,
              };
              this.cart = [];
              this.showProduct = true;
            } else {
              alert("Please Correct The Errors Before Submitting!");
            }
          },
          getFullStateName: function (stateCode) {
            return this.states[stateCode] || "Unknown State";
          },
          setRating: function (product, rating) {
            product.rating = rating;
          },
          filterProducts: function () {
            const query = this.searchQuery
              ? this.searchQuery.toLowerCase()
              : "";
            return this.products.filter((product) => {
              const priceString = product.price.toString();
              const stockString = product.availableInventory.toString();
              const ratingString = product.rating.toString();
              const isTextMatch =
                product.subject.toLowerCase().includes(query) ||
                product.description.toLowerCase().includes(query) ||
                product.location.toLowerCase().includes(query);
              const isNumberMatch =
                priceString.includes(query) ||
                stockString.includes(query) ||
                ratingString.includes(query);
              return isTextMatch || isNumberMatch;
            });
          },
        },
        computed: {
          itemsInTheCart: function () {
            return this.cart.length;
          },
          sortedProducts: function () {
            let sorted = this.filterProducts().sort((a, b) => {
              if (
                this.sortKey === "price" ||
                this.sortKey === "availableInventory" ||
                this.sortKey === "rating"
              ) {
                return a[this.sortKey] - b[this.sortKey];
              } else {
                return a[this.sortKey].localeCompare(b[this.sortKey]);
              }
            });
            if (this.orderKey === "Descending") {
              sorted.reverse();
            }
            return sorted;
          },
          filteredProducts: function () {
            const query = this.searchQuery.toLowerCase();
            return this.products.filter(
              (product) =>
                product.subject.toLowerCase().includes(query) ||
                product.description.toLowerCase().includes(query)
            );
          },
        },
        mounted() {
          this.fetchData();
        },
      });
    </script>
    <!--Footer-->
    <footer class>
      <p>
        Created by Arbaaz Ali Hussain M00872279 &copy; . Contact:
        <a href="ah2010@live.mdx.ac.uk" target="_blank"> Send me an Email </a>
        Middlesex University London. The Burroughs, NW4 4BT.
        <a href="tel:02084115000"> Call MDX </a>
      </p>
    </footer>
  </body>
</html>
